{"ast":null,"code":"var __jsx = React.createElement;\nimport React, { useState, useEffect, useRef } from 'react';\nimport styles from './ChatBubble.module.scss';\nimport { connect } from 'react-redux';\nimport { toggleChatBubble } from 'redux/actions/ui';\nimport { toggleRegisterLogin } from 'redux/actions/ui';\nimport ChatWindow from '../ChatWindow'; // @ts-ignore\n\nimport io from 'socket.io-client';\nimport scrollToBottom from 'components/utils/scrollBottom';\nimport { message } from 'antd';\nimport axios from 'config/axios';\nimport baseUrl from 'config/basedUrl';\nimport localStorage from 'local-storage'; // @ts-ignore\n\nconst token = localStorage.get('spn_auth');\nconst header = {\n  headers: {\n    'Authorization': 'Bearer ' + token\n  }\n};\n\nfunction ChatBubble({\n  openChatBubble,\n  toggleChatBubble,\n  user,\n  toggleRegisterLogin\n}) {\n  const {\n    0: messages,\n    1: setMessages\n  } = useState([]);\n  const {\n    0: isOnline,\n    1: setOnline\n  } = useState(false);\n  const socketRef = useRef();\n\n  const handleOpenChat = () => {\n    toggleChatBubble(true);\n\n    if (user) {\n      // @ts-ignore\n      socketRef.current.emit('Set seen', {\n        user: 'Admin',\n        roomId: user._id\n      });\n    }\n  };\n\n  const handleCloseChat = () => {\n    toggleChatBubble(false);\n  };\n\n  const handleOpenLogin = () => {\n    toggleRegisterLogin(true, 'login');\n  };\n\n  const handleSendMessage = text => {\n    if (text) {\n      // @ts-ignore\n      socketRef.current.emit('Chat Message', {\n        data: {\n          roomId: user._id,\n          message: text,\n          sender: user.name,\n          type: 'text',\n          createdAt: Date.now(),\n          roomName: user.name\n        },\n        roomId: user._id\n      }); // @ts-ignore\n    }\n  };\n\n  useEffect(() => {\n    socketRef.current = io(baseUrl);\n\n    if (user) {\n      // @ts-ignore\n      socketRef.current.emit('Login', {\n        userId: user._id\n      }); // @ts-ignore\n\n      socketRef.current.emit('Join room', {\n        roomId: user._id\n      });\n\n      try {\n        axios.post('/messages', {\n          roomId: user._id\n        }).then(res => {\n          if (res.data.messages.length) {\n            setMessages(res.data.messages); // console.log(res.data.messages);\n          } else {\n            // @ts-ignore\n            socketRef.current.emit('Initialize Chat', {\n              roomId: user._id,\n              roomName: user.name\n            });\n          }\n        });\n      } catch (error) {\n        message.error(error.response.error);\n      } // @ts-ignore\n\n\n      socketRef.current.on('Chat Message', msg => {\n        // @ts-ignore\n        setMessages(oldMessages => [...oldMessages, msg]);\n      }); // @ts-ignore\n\n      socketRef.current.on('Chat Error', err => {\n        message.error(err.response);\n      }); // @ts-ignore\n\n      socketRef.current.on('Active Users', data => {\n        const dataArr = Object.values(data);\n\n        if (dataArr.includes('Admin')) {\n          setOnline(true);\n        } else {\n          setOnline(false);\n        }\n      }); // @ts-ignore\n\n      socketRef.current.on('Set Seen', () => {\n        axios.post('/messages', {\n          roomId: user._id\n        }, header).then(res => {\n          setMessages(res.data.messages);\n        });\n      });\n    } else {\n      toggleChatBubble(false);\n    }\n  }, [user]);\n\n  const handleSetSeen = () => {\n    if (user) {\n      // @ts-ignore\n      socketRef.current.emit('Set seen', {\n        user: 'Admin',\n        roomId: user._id\n      });\n    }\n  };\n\n  useEffect(() => {\n    if (openChatBubble) {\n      scrollToBottom();\n    }\n  }, [messages, openChatBubble]);\n  return __jsx(React.Fragment, null, openChatBubble ? __jsx(ChatWindow, {\n    user: user,\n    handleOpenLogin: handleOpenLogin,\n    handleSendMessage: handleSendMessage,\n    handleCloseChat: handleCloseChat,\n    messages: messages,\n    isOnline: isOnline,\n    roomInfo: true,\n    handleClick: handleSetSeen\n  }) : __jsx(\"div\", {\n    className: styles.icon,\n    onClick: handleOpenChat\n  }, __jsx(\"img\", {\n    src: \"/icons/chat.svg\",\n    alt: \"chat\"\n  })));\n}\n\nconst mapStateToProps = state => ({\n  openChatBubble: state.ui.openChatBubble,\n  user: state.users.data\n});\n\nexport default connect(mapStateToProps, {\n  toggleChatBubble,\n  toggleRegisterLogin\n})(ChatBubble);","map":null,"metadata":{},"sourceType":"module"}