{"ast":null,"code":"import _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\n\nvar _s = $RefreshSig$();\n\nvar __jsx = React.createElement;\nimport React, { useEffect, useState, useRef } from 'react';\nimport { Dropdown } from 'antd';\nimport axios from 'config/axios';\nimport styles from './AdminMessages.module.scss';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport UserAvatar from 'components/UserAvatar';\nimport Button from '@material-ui/core/Button';\nimport ModeCommentIcon from '@material-ui/icons/ModeComment';\nimport ChatWindow from '../ChatWindow';\nimport scrollToBottom from 'components/utils/scrollBottom'; // @ts-ignore\n\nimport io from 'socket.io-client';\nimport { toggleChatBubble } from 'redux/actions/ui';\nimport { connect } from 'react-redux';\nimport moment from 'moment';\nimport baseUrl from 'config/basedUrl';\n\nfunction AdminMessages(_ref) {\n  _s();\n\n  var toggleChatBubble = _ref.toggleChatBubble,\n      openChatWindow = _ref.openChatWindow;\n\n  var _useState = useState([]),\n      messages = _useState[0],\n      setMessages = _useState[1];\n\n  var _useState2 = useState(false),\n      isOnline = _useState2[0],\n      setOnline = _useState2[1];\n\n  var _useState3 = useState([]),\n      currentMessages = _useState3[0],\n      setCurrentMessages = _useState3[1];\n\n  var _useState4 = useState({\n    roomName: '',\n    roomId: ''\n  }),\n      currentRoomInfo = _useState4[0],\n      setCurrentRoomInfo = _useState4[1];\n\n  var socketRef = useRef();\n\n  var _useState5 = useState(),\n      activeUsers = _useState5[0],\n      setActiveUsers = _useState5[1];\n\n  var _useState6 = useState(false),\n      openNontification = _useState6[0],\n      setOpenNontification = _useState6[1];\n\n  var sortMessages = function sortMessages(messages) {\n    return messages.sort(function (a, b) {\n      return b.createdAt - a.createdAt;\n    });\n  };\n\n  useEffect(function () {\n    socketRef.current = io(baseUrl); // @ts-ignore\n\n    socketRef.current.emit('Login', {\n      userId: 'Admin'\n    });\n    axios.get('/messages/admin').then(function (res) {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages));\n        res.data.lastChatMessages.map(function (message) {\n          if (!message.seen && message.sender !== 'Admin') {\n            setOpenNontification(true);\n          }\n        }); // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    }); // @ts-ignore\n\n    socketRef.current.on('Chat Message', function (data) {\n      // @ts-ignore\n      setCurrentMessages(function (oldMessages) {\n        return [].concat(_toConsumableArray(oldMessages), [data]);\n      });\n    }); // @ts-ignore\n\n    socketRef.current.on('Active Users', function (data) {\n      var dataArr = Object.values(data); // @ts-ignore\n\n      setActiveUsers(dataArr);\n    }); // @ts-ignore\n\n    socketRef.current.on('Admin Last Messages', function (data) {\n      if (data.sender !== 'Admin') setOpenNontification(true);\n    });\n  }, []);\n\n  var handleCloseChat = function handleCloseChat() {\n    toggleChatBubble(false);\n  };\n\n  useEffect(function () {\n    if (openChatWindow) {\n      scrollToBottom();\n    }\n  }, [currentMessages, openChatWindow]);\n\n  var handleOpenWindowChat = function handleOpenWindowChat(roomId, roomName) {\n    // axios.post('/messages', { roomId }).then((res) => {\n    // @ts-ignore\n    socketRef.current.emit('Join room', {\n      roomId: roomId\n    });\n    setCurrentRoomInfo({\n      roomId: roomId,\n      roomName: roomName\n    }); // @ts-ignore\n\n    socketRef.current.emit('Set seen', {\n      user: roomName,\n      roomId: roomId\n    });\n    toggleChatBubble(false);\n    toggleChatBubble(true); // });\n  };\n\n  var handleSetSeen = function handleSetSeen() {\n    // @ts-ignore\n    socketRef.current.emit('Set seen', {\n      user: currentRoomInfo.roomName,\n      roomId: currentRoomInfo.roomId\n    });\n    setOpenNontification(false);\n  };\n\n  var handleSendMessage = function handleSendMessage(text) {\n    if (text) {\n      // @ts-ignore\n      socketRef.current.emit('Chat Message', {\n        data: {\n          roomId: currentRoomInfo.roomId,\n          message: text,\n          sender: 'Admin',\n          type: 'text',\n          createdAt: Date.now(),\n          roomName: currentRoomInfo.roomName\n        },\n        roomId: currentRoomInfo.roomId\n      });\n    }\n  };\n\n  var handleLoadMessages = function handleLoadMessages() {\n    // console.log('load messages');\n    setOpenNontification(false);\n    axios.get('/messages/admin').then(function (res) {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages)); // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    });\n  };\n\n  useEffect(function () {\n    if (currentRoomInfo.roomId && currentRoomInfo.roomName) {\n      // @ts-ignore\n      setOnline(activeUsers.includes(currentRoomInfo.roomId)); // @ts-ignore\n\n      socketRef.current.on('Set Seen', function () {\n        axios.post('/messages', {\n          roomId: currentRoomInfo.roomId\n        }).then(function (res) {\n          setCurrentMessages(res.data.messages);\n        });\n      });\n    }\n  }, [currentRoomInfo, activeUsers]);\n\n  var messageDropdown = function messageDropdown() {\n    if (messages === null) {\n      return __jsx(\"div\", {\n        className: styles.messagesWrapper\n      }, __jsx(\"div\", {\n        className: styles.noMessage\n      }, \"Kh\\xF4ng c\\xF3 tin nh\\u1EAFn n\\xE0o\"));\n    } else if (!messages.length) {\n      return __jsx(\"div\", {\n        className: styles.messagesWrapper\n      }, __jsx(\"div\", {\n        className: styles.loading\n      }, __jsx(CircularProgress, {\n        color: \"secondary\",\n        size: 25\n      })));\n    } else {\n      return __jsx(\"div\", {\n        className: styles.messagesWrapper\n      }, messages.map(function (message, i) {\n        return __jsx(\"div\", {\n          className: styles.messageItem,\n          key: i,\n          onClick: function onClick() {\n            return handleOpenWindowChat(message.roomId, message.roomName);\n          }\n        }, __jsx(\"div\", {\n          className: styles.avatar\n        }, __jsx(UserAvatar, {\n          userId: message.roomId,\n          key: i\n        }), activeUsers.includes(message.roomId) && __jsx(\"div\", {\n          className: styles.dot\n        })), __jsx(\"div\", {\n          className: styles.middleMessage\n        }, __jsx(\"div\", {\n          className: styles.name\n        }, message.roomName), __jsx(\"div\", {\n          className: styles.message // @ts-ignore\n          ,\n          style: message.seen || message.sender === 'Admin' ? {\n            color: 'gray'\n          } : null\n        }, message.sender === 'Admin' ? 'Bạn: ' : \"\".concat(message.sender, \": \"), message.message)), __jsx(\"div\", {\n          className: styles.rightMessage\n        }, moment(message.createdAt).locale('vi').startOf('minute').fromNow()));\n      }));\n    }\n  };\n\n  return __jsx(React.Fragment, null, __jsx(Dropdown, {\n    overlay: messageDropdown,\n    placement: \"bottomCenter\",\n    trigger: ['click']\n  }, __jsx(Button, {\n    onClick: function onClick() {\n      return handleLoadMessages();\n    }\n  }, __jsx(\"div\", {\n    className: styles.topItem\n  }, __jsx(ModeCommentIcon, null), openNontification && __jsx(\"div\", {\n    className: styles.dot\n  })))), openChatWindow && __jsx(ChatWindow, {\n    user: true,\n    roomInfo: currentRoomInfo,\n    handleSendMessage: handleSendMessage,\n    handleCloseChat: handleCloseChat,\n    messages: currentMessages,\n    isAdmin: true // @ts-ignore\n    ,\n    isOnline: isOnline,\n    handleClick: handleSetSeen\n  }));\n}\n\n_s(AdminMessages, \"OT5FWm5ggYjwGDjFTlAB4ND5cRI=\");\n\n_c = AdminMessages;\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    openChatWindow: state.ui.openChatBubble\n  };\n};\n\nexport default connect(mapStateToProps, {\n  toggleChatBubble: toggleChatBubble\n})(AdminMessages);\n\nvar _c;\n\n$RefreshReg$(_c, \"AdminMessages\");","map":{"version":3,"sources":["/media/robert/DATA/Work/web-project/phuong-nam/src-code/components/AdminMessages/index.tsx"],"names":["React","useEffect","useState","useRef","Dropdown","axios","styles","CircularProgress","UserAvatar","Button","ModeCommentIcon","ChatWindow","scrollToBottom","io","toggleChatBubble","connect","moment","baseUrl","AdminMessages","openChatWindow","messages","setMessages","isOnline","setOnline","currentMessages","setCurrentMessages","roomName","roomId","currentRoomInfo","setCurrentRoomInfo","socketRef","activeUsers","setActiveUsers","openNontification","setOpenNontification","sortMessages","sort","a","b","createdAt","current","emit","userId","get","then","res","data","lastChatMessages","length","map","message","seen","sender","on","oldMessages","dataArr","Object","values","handleCloseChat","handleOpenWindowChat","user","handleSetSeen","handleSendMessage","text","type","Date","now","handleLoadMessages","includes","post","messageDropdown","messagesWrapper","noMessage","loading","i","messageItem","avatar","dot","middleMessage","name","color","rightMessage","locale","startOf","fromNow","topItem","mapStateToProps","state","ui","openChatBubble"],"mappings":"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","sourcesContent":["import React, { useEffect, useState, useRef } from 'react';\nimport { Dropdown } from 'antd';\nimport axios from 'config/axios';\nimport styles from './AdminMessages.module.scss';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport UserAvatar from 'components/UserAvatar';\nimport Button from '@material-ui/core/Button';\nimport ModeCommentIcon from '@material-ui/icons/ModeComment';\nimport ChatWindow from '../ChatWindow';\nimport scrollToBottom from 'components/utils/scrollBottom';\n// @ts-ignore\nimport io from 'socket.io-client';\nimport { toggleChatBubble } from 'redux/actions/ui';\nimport { connect } from 'react-redux';\nimport moment from 'moment';\nimport baseUrl from 'config/basedUrl'\n\nfunction AdminMessages({ toggleChatBubble, openChatWindow }: any) {\n  const [messages, setMessages] = useState([]);\n  const [isOnline, setOnline] = useState(false);\n  const [currentMessages, setCurrentMessages] = useState([]);\n  const [currentRoomInfo, setCurrentRoomInfo] = useState({\n    roomName: '',\n    roomId: '',\n  });\n  const socketRef = useRef();\n  const [activeUsers, setActiveUsers] = useState();\n  const [openNontification, setOpenNontification] = useState(false);\n\n  const sortMessages = (messages: any) => {\n    return messages.sort((a: any, b: any) => {\n      return b.createdAt - a.createdAt;\n    });\n  };\n\n  useEffect(() => {\n    socketRef.current = io(baseUrl);\n    // @ts-ignore\n    socketRef.current.emit('Login', { userId: 'Admin' });\n\n    axios.get('/messages/admin').then((res: any) => {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages));\n        res.data.lastChatMessages.map((message: any) => {\n          if (!message.seen && message.sender !== 'Admin') {\n            setOpenNontification(true);\n          }\n        });\n        // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    });\n    // @ts-ignore\n    socketRef.current.on('Chat Message', (data: any) => {\n      // @ts-ignore\n      setCurrentMessages((oldMessages) => [...oldMessages, data]);\n    });\n\n    // @ts-ignore\n    socketRef.current.on('Active Users', (data) => {\n      const dataArr = Object.values(data);\n      // @ts-ignore\n      setActiveUsers(dataArr);\n    });\n\n    // @ts-ignore\n    socketRef.current.on('Admin Last Messages', (data) => {\n      if (data.sender !== 'Admin') setOpenNontification(true);\n    });\n  }, []);\n\n  const handleCloseChat = () => {\n    toggleChatBubble(false);\n  };\n\n  useEffect(() => {\n    if (openChatWindow) {\n      scrollToBottom();\n    }\n  }, [currentMessages, openChatWindow]);\n\n  const handleOpenWindowChat = (roomId: string, roomName: string) => {\n    // axios.post('/messages', { roomId }).then((res) => {\n    // @ts-ignore\n    socketRef.current.emit('Join room', { roomId });\n    setCurrentRoomInfo({\n      roomId: roomId,\n      roomName: roomName,\n    });\n    // @ts-ignore\n    socketRef.current.emit('Set seen', { user: roomName, roomId });\n    toggleChatBubble(false);\n    toggleChatBubble(true);\n    // });\n  };\n\n  const handleSetSeen = () => {\n    // @ts-ignore\n    socketRef.current.emit('Set seen', { user: currentRoomInfo.roomName, roomId: currentRoomInfo.roomId });\n    setOpenNontification(false);\n  };\n\n  const handleSendMessage = (text: any) => {\n    if (text) {\n      // @ts-ignore\n      socketRef.current.emit('Chat Message', {\n        data: {\n          roomId: currentRoomInfo.roomId,\n          message: text,\n          sender: 'Admin',\n          type: 'text',\n          createdAt: Date.now(),\n          roomName: currentRoomInfo.roomName,\n        },\n        roomId: currentRoomInfo.roomId,\n      });\n    }\n  };\n\n  const handleLoadMessages = () => {\n    // console.log('load messages');\n    setOpenNontification(false);\n    axios.get('/messages/admin').then((res: any) => {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages));\n        // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    });\n  };\n\n  useEffect(() => {\n    if (currentRoomInfo.roomId && currentRoomInfo.roomName) {\n      // @ts-ignore\n      setOnline(activeUsers.includes(currentRoomInfo.roomId));\n      // @ts-ignore\n      socketRef.current.on('Set Seen', () => {\n        axios.post('/messages', { roomId: currentRoomInfo.roomId }).then((res) => {\n          setCurrentMessages(res.data.messages);\n        });\n      });\n    }\n  }, [currentRoomInfo, activeUsers]);\n\n  const messageDropdown = () => {\n    if (messages === null) {\n      return (\n        <div className={styles.messagesWrapper}>\n          <div className={styles.noMessage}>Không có tin nhắn nào</div>\n        </div>\n      );\n    } else if (!messages.length) {\n      return (\n        <div className={styles.messagesWrapper}>\n          <div className={styles.loading}>\n            <CircularProgress color=\"secondary\" size={25} />\n          </div>\n        </div>\n      );\n    } else {\n      return (\n        <div className={styles.messagesWrapper}>\n          {messages.map((message: any, i) => (\n            <div\n              className={styles.messageItem}\n              key={i}\n              onClick={() => handleOpenWindowChat(message.roomId, message.roomName)}\n            >\n              <div className={styles.avatar}>\n                {/* @ts-ignore */}\n                <UserAvatar userId={message.roomId} key={i} />\n                {/* @ts-ignore */}\n                {activeUsers.includes(message.roomId) && <div className={styles.dot}></div>}\n              </div>\n              <div className={styles.middleMessage}>\n                <div className={styles.name}>{message.roomName}</div>\n                {/* @ts-ignore */}\n                <div\n                  className={styles.message}\n                  // @ts-ignore\n                  style={message.seen || message.sender === 'Admin' ? { color: 'gray' } : null}\n                >\n                  {message.sender === 'Admin' ? 'Bạn: ' : `${message.sender}: `}\n                  {message.message}\n                </div>\n              </div>\n              <div className={styles.rightMessage}>\n                {moment(message.createdAt).locale('vi').startOf('minute').fromNow()}\n              </div>\n            </div>\n          ))}\n        </div>\n      );\n    }\n  };\n  return (\n    <>\n      <Dropdown overlay={messageDropdown} placement=\"bottomCenter\" trigger={['click']}>\n        <Button onClick={() => handleLoadMessages()}>\n          <div className={styles.topItem}>\n            <ModeCommentIcon />\n            {openNontification && <div className={styles.dot}></div>}\n          </div>\n        </Button>\n      </Dropdown>\n      {openChatWindow && (\n        <ChatWindow\n          user={true}\n          roomInfo={currentRoomInfo}\n          handleSendMessage={handleSendMessage}\n          handleCloseChat={handleCloseChat}\n          messages={currentMessages}\n          isAdmin={true}\n          // @ts-ignore\n          isOnline={isOnline}\n          handleClick={handleSetSeen}\n        />\n      )}\n    </>\n  );\n}\n\nconst mapStateToProps = (state: any) => ({\n  openChatWindow: state.ui.openChatBubble,\n});\n\nexport default connect(mapStateToProps, { toggleChatBubble })(AdminMessages);\n"]},"metadata":{},"sourceType":"module"}