{"ast":null,"code":"var __jsx = React.createElement;\nimport React, { useEffect, useState, useRef } from 'react';\nimport { Dropdown } from 'antd';\nimport axios from 'config/axios';\nimport styles from './AdminMessages.module.scss';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport UserAvatar from 'components/UserAvatar';\nimport Button from '@material-ui/core/Button';\nimport ModeCommentIcon from '@material-ui/icons/ModeComment';\nimport ChatWindow from '../ChatWindow';\nimport scrollToBottom from 'components/utils/scrollBottom'; // @ts-ignore\n\nimport io from 'socket.io-client';\nimport { toggleChatBubble } from 'redux/actions/ui';\nimport { connect } from 'react-redux';\nimport moment from 'moment';\nimport baseUrl from 'config/basedUrl';\nimport localStorage from 'local-storage';\n\nfunction AdminMessages({\n  toggleChatBubble,\n  openChatWindow\n}) {\n  const {\n    0: messages,\n    1: setMessages\n  } = useState([]);\n  const {\n    0: isOnline,\n    1: setOnline\n  } = useState(false);\n  const {\n    0: currentMessages,\n    1: setCurrentMessages\n  } = useState([]);\n  const {\n    0: currentRoomInfo,\n    1: setCurrentRoomInfo\n  } = useState({\n    roomName: '',\n    roomId: ''\n  });\n  const socketRef = useRef();\n  const {\n    0: activeUsers,\n    1: setActiveUsers\n  } = useState();\n  const {\n    0: openNontification,\n    1: setOpenNontification\n  } = useState(false);\n\n  const sortMessages = messages => {\n    return messages.sort((a, b) => {\n      return b.createdAt - a.createdAt;\n    });\n  };\n\n  useEffect(() => {\n    socketRef.current = io(baseUrl); // @ts-ignore\n\n    socketRef.current.emit('Login', {\n      userId: 'Admin'\n    }); // @ts-ignore\n\n    const token = localStorage.get('spn_auth');\n    const header = {\n      headers: {\n        'Authorization': 'Bearer ' + token\n      }\n    };\n    axios.get('/messages/admin', header).then(res => {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages));\n        res.data.lastChatMessages.map(message => {\n          if (!message.seen && message.sender !== 'Admin') {\n            setOpenNontification(true);\n          }\n        }); // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    }); // @ts-ignore\n\n    socketRef.current.on('Chat Message', data => {\n      // @ts-ignore\n      setCurrentMessages(oldMessages => [...oldMessages, data]);\n    }); // @ts-ignore\n\n    socketRef.current.on('Active Users', data => {\n      const dataArr = Object.values(data); // @ts-ignore\n\n      setActiveUsers(dataArr);\n    }); // @ts-ignore\n\n    socketRef.current.on('Admin Last Messages', data => {\n      if (data.sender !== 'Admin') setOpenNontification(true);\n    });\n  }, []);\n\n  const handleCloseChat = () => {\n    toggleChatBubble(false);\n  };\n\n  useEffect(() => {\n    if (openChatWindow) {\n      scrollToBottom();\n    }\n  }, [currentMessages, openChatWindow]);\n\n  const handleOpenWindowChat = (roomId, roomName) => {\n    // axios.post('/messages', { roomId }).then((res) => {\n    // @ts-ignore\n    socketRef.current.emit('Join room', {\n      roomId\n    });\n    setCurrentRoomInfo({\n      roomId: roomId,\n      roomName: roomName\n    }); // @ts-ignore\n\n    socketRef.current.emit('Set seen', {\n      user: roomName,\n      roomId\n    });\n    toggleChatBubble(false);\n    toggleChatBubble(true); // });\n  };\n\n  const handleSetSeen = () => {\n    // @ts-ignore\n    socketRef.current.emit('Set seen', {\n      user: currentRoomInfo.roomName,\n      roomId: currentRoomInfo.roomId\n    });\n    setOpenNontification(false);\n  };\n\n  const handleSendMessage = text => {\n    if (text) {\n      // @ts-ignore\n      socketRef.current.emit('Chat Message', {\n        data: {\n          roomId: currentRoomInfo.roomId,\n          message: text,\n          sender: 'Admin',\n          type: 'text',\n          createdAt: Date.now(),\n          roomName: currentRoomInfo.roomName\n        },\n        roomId: currentRoomInfo.roomId\n      });\n    }\n  };\n\n  const handleLoadMessages = () => {\n    // console.log('load messages');\n    setOpenNontification(false);\n    axios.get('/messages/admin').then(res => {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages)); // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    });\n  };\n\n  useEffect(() => {\n    if (currentRoomInfo.roomId && currentRoomInfo.roomName) {\n      // @ts-ignore\n      setOnline(activeUsers.includes(currentRoomInfo.roomId)); // @ts-ignore\n\n      socketRef.current.on('Set Seen', () => {\n        axios.post('/messages', {\n          roomId: currentRoomInfo.roomId\n        }).then(res => {\n          setCurrentMessages(res.data.messages);\n        });\n      });\n    }\n  }, [currentRoomInfo, activeUsers]);\n\n  const messageDropdown = () => {\n    if (messages === null) {\n      return __jsx(\"div\", {\n        className: styles.messagesWrapper\n      }, __jsx(\"div\", {\n        className: styles.noMessage\n      }, \"Kh\\xF4ng c\\xF3 tin nh\\u1EAFn n\\xE0o\"));\n    } else if (!messages.length) {\n      return __jsx(\"div\", {\n        className: styles.messagesWrapper\n      }, __jsx(\"div\", {\n        className: styles.loading\n      }, __jsx(CircularProgress, {\n        color: \"secondary\",\n        size: 25\n      })));\n    } else {\n      return __jsx(\"div\", {\n        className: styles.messagesWrapper\n      }, messages.map((message, i) => __jsx(\"div\", {\n        className: styles.messageItem,\n        key: i,\n        onClick: () => handleOpenWindowChat(message.roomId, message.roomName)\n      }, __jsx(\"div\", {\n        className: styles.avatar\n      }, __jsx(UserAvatar, {\n        userId: message.roomId,\n        key: i\n      }), activeUsers.includes(message.roomId) && __jsx(\"div\", {\n        className: styles.dot\n      })), __jsx(\"div\", {\n        className: styles.middleMessage\n      }, __jsx(\"div\", {\n        className: styles.name\n      }, message.roomName), __jsx(\"div\", {\n        className: styles.message // @ts-ignore\n        ,\n        style: message.seen || message.sender === 'Admin' ? {\n          color: 'gray'\n        } : null\n      }, message.sender === 'Admin' ? 'Bạn: ' : `${message.sender}: `, message.message)), __jsx(\"div\", {\n        className: styles.rightMessage\n      }, moment(message.createdAt).locale('vi').startOf('minute').fromNow()))));\n    }\n  };\n\n  return __jsx(React.Fragment, null, __jsx(Dropdown, {\n    overlay: messageDropdown,\n    placement: \"bottomCenter\",\n    trigger: ['click']\n  }, __jsx(Button, {\n    onClick: () => handleLoadMessages()\n  }, __jsx(\"div\", {\n    className: styles.topItem\n  }, __jsx(ModeCommentIcon, null), openNontification && __jsx(\"div\", {\n    className: styles.dot\n  })))), openChatWindow && __jsx(ChatWindow, {\n    user: true,\n    roomInfo: currentRoomInfo,\n    handleSendMessage: handleSendMessage,\n    handleCloseChat: handleCloseChat,\n    messages: currentMessages,\n    isAdmin: true // @ts-ignore\n    ,\n    isOnline: isOnline,\n    handleClick: handleSetSeen\n  }));\n}\n\nconst mapStateToProps = state => ({\n  openChatWindow: state.ui.openChatBubble\n});\n\nexport default connect(mapStateToProps, {\n  toggleChatBubble\n})(AdminMessages);","map":{"version":3,"sources":["/media/robert/DATA/Work/web-project/phuong-nam/src-code/components/AdminMessages/index.tsx"],"names":["React","useEffect","useState","useRef","Dropdown","axios","styles","CircularProgress","UserAvatar","Button","ModeCommentIcon","ChatWindow","scrollToBottom","io","toggleChatBubble","connect","moment","baseUrl","localStorage","AdminMessages","openChatWindow","messages","setMessages","isOnline","setOnline","currentMessages","setCurrentMessages","currentRoomInfo","setCurrentRoomInfo","roomName","roomId","socketRef","activeUsers","setActiveUsers","openNontification","setOpenNontification","sortMessages","sort","a","b","createdAt","current","emit","userId","token","get","header","headers","then","res","data","lastChatMessages","length","map","message","seen","sender","on","oldMessages","dataArr","Object","values","handleCloseChat","handleOpenWindowChat","user","handleSetSeen","handleSendMessage","text","type","Date","now","handleLoadMessages","includes","post","messageDropdown","messagesWrapper","noMessage","loading","i","messageItem","avatar","dot","middleMessage","name","color","rightMessage","locale","startOf","fromNow","topItem","mapStateToProps","state","ui","openChatBubble"],"mappings":"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","sourcesContent":["import React, { useEffect, useState, useRef } from 'react';\nimport { Dropdown } from 'antd';\nimport axios from 'config/axios';\nimport styles from './AdminMessages.module.scss';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport UserAvatar from 'components/UserAvatar';\nimport Button from '@material-ui/core/Button';\nimport ModeCommentIcon from '@material-ui/icons/ModeComment';\nimport ChatWindow from '../ChatWindow';\nimport scrollToBottom from 'components/utils/scrollBottom';\n// @ts-ignore\nimport io from 'socket.io-client';\nimport { toggleChatBubble } from 'redux/actions/ui';\nimport { connect } from 'react-redux';\nimport moment from 'moment';\nimport baseUrl from 'config/basedUrl';\nimport localStorage from 'local-storage';\n\nfunction AdminMessages({ toggleChatBubble, openChatWindow }: any) {\n  const [messages, setMessages] = useState([]);\n  const [isOnline, setOnline] = useState(false);\n  const [currentMessages, setCurrentMessages] = useState([]);\n  const [currentRoomInfo, setCurrentRoomInfo] = useState({\n    roomName: '',\n    roomId: '',\n  });\n  const socketRef = useRef();\n  const [activeUsers, setActiveUsers] = useState();\n  const [openNontification, setOpenNontification] = useState(false);\n\n  const sortMessages = (messages: any) => {\n    return messages.sort((a: any, b: any) => {\n      return b.createdAt - a.createdAt;\n    });\n  };\n\n  useEffect(() => {\n    socketRef.current = io(baseUrl);\n    // @ts-ignore\n    socketRef.current.emit('Login', { userId: 'Admin' });\n\n    // @ts-ignore\n    const token = localStorage.get('spn_auth')\n    const header = {\n      headers: {\n        'Authorization': 'Bearer ' + token\n      }\n    }\n    \n\n    axios.get('/messages/admin', header).then((res: any) => {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages));\n        res.data.lastChatMessages.map((message: any) => {\n          if (!message.seen && message.sender !== 'Admin') {\n            setOpenNontification(true);\n          }\n        });\n        // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    });\n    // @ts-ignore\n    socketRef.current.on('Chat Message', (data: any) => {\n      // @ts-ignore\n      setCurrentMessages((oldMessages) => [...oldMessages, data]);\n    });\n\n    // @ts-ignore\n    socketRef.current.on('Active Users', (data) => {\n      const dataArr = Object.values(data);\n      // @ts-ignore\n      setActiveUsers(dataArr);\n    });\n\n    // @ts-ignore\n    socketRef.current.on('Admin Last Messages', (data) => {\n      if (data.sender !== 'Admin') setOpenNontification(true);\n    });\n  }, []);\n\n  const handleCloseChat = () => {\n    toggleChatBubble(false);\n  };\n\n  useEffect(() => {\n    if (openChatWindow) {\n      scrollToBottom();\n    }\n  }, [currentMessages, openChatWindow]);\n\n  const handleOpenWindowChat = (roomId: string, roomName: string) => {\n    // axios.post('/messages', { roomId }).then((res) => {\n    // @ts-ignore\n    socketRef.current.emit('Join room', { roomId });\n    setCurrentRoomInfo({\n      roomId: roomId,\n      roomName: roomName,\n    });\n    // @ts-ignore\n    socketRef.current.emit('Set seen', { user: roomName, roomId });\n    toggleChatBubble(false);\n    toggleChatBubble(true);\n    // });\n  };\n\n  const handleSetSeen = () => {\n    // @ts-ignore\n    socketRef.current.emit('Set seen', { user: currentRoomInfo.roomName, roomId: currentRoomInfo.roomId });\n    setOpenNontification(false);\n  };\n\n  const handleSendMessage = (text: any) => {\n    if (text) {\n      // @ts-ignore\n      socketRef.current.emit('Chat Message', {\n        data: {\n          roomId: currentRoomInfo.roomId,\n          message: text,\n          sender: 'Admin',\n          type: 'text',\n          createdAt: Date.now(),\n          roomName: currentRoomInfo.roomName,\n        },\n        roomId: currentRoomInfo.roomId,\n      });\n    }\n  };\n\n  const handleLoadMessages = () => {\n    // console.log('load messages');\n    setOpenNontification(false);\n    axios.get('/messages/admin').then((res: any) => {\n      if (res.data.lastChatMessages.length) {\n        // setMessages(res.data.lastChatMessages);\n        setMessages(sortMessages(res.data.lastChatMessages));\n        // @ts-ignore\n      } else {\n        // @ts-ignore\n        setMessages(null);\n      }\n    });\n  };\n\n  useEffect(() => {\n    if (currentRoomInfo.roomId && currentRoomInfo.roomName) {\n      // @ts-ignore\n      setOnline(activeUsers.includes(currentRoomInfo.roomId));\n      // @ts-ignore\n      socketRef.current.on('Set Seen', () => {\n        axios.post('/messages', { roomId: currentRoomInfo.roomId }).then((res) => {\n          setCurrentMessages(res.data.messages);\n        });\n      });\n    }\n  }, [currentRoomInfo, activeUsers]);\n\n  const messageDropdown = () => {\n    if (messages === null) {\n      return (\n        <div className={styles.messagesWrapper}>\n          <div className={styles.noMessage}>Không có tin nhắn nào</div>\n        </div>\n      );\n    } else if (!messages.length) {\n      return (\n        <div className={styles.messagesWrapper}>\n          <div className={styles.loading}>\n            <CircularProgress color=\"secondary\" size={25} />\n          </div>\n        </div>\n      );\n    } else {\n      return (\n        <div className={styles.messagesWrapper}>\n          {messages.map((message: any, i) => (\n            <div\n              className={styles.messageItem}\n              key={i}\n              onClick={() => handleOpenWindowChat(message.roomId, message.roomName)}\n            >\n              <div className={styles.avatar}>\n                {/* @ts-ignore */}\n                <UserAvatar userId={message.roomId} key={i} />\n                {/* @ts-ignore */}\n                {activeUsers.includes(message.roomId) && <div className={styles.dot}></div>}\n              </div>\n              <div className={styles.middleMessage}>\n                <div className={styles.name}>{message.roomName}</div>\n                {/* @ts-ignore */}\n                <div\n                  className={styles.message}\n                  // @ts-ignore\n                  style={message.seen || message.sender === 'Admin' ? { color: 'gray' } : null}\n                >\n                  {message.sender === 'Admin' ? 'Bạn: ' : `${message.sender}: `}\n                  {message.message}\n                </div>\n              </div>\n              <div className={styles.rightMessage}>\n                {moment(message.createdAt).locale('vi').startOf('minute').fromNow()}\n              </div>\n            </div>\n          ))}\n        </div>\n      );\n    }\n  };\n  return (\n    <>\n      <Dropdown overlay={messageDropdown} placement=\"bottomCenter\" trigger={['click']}>\n        <Button onClick={() => handleLoadMessages()}>\n          <div className={styles.topItem}>\n            <ModeCommentIcon />\n            {openNontification && <div className={styles.dot}></div>}\n          </div>\n        </Button>\n      </Dropdown>\n      {openChatWindow && (\n        <ChatWindow\n          user={true}\n          roomInfo={currentRoomInfo}\n          handleSendMessage={handleSendMessage}\n          handleCloseChat={handleCloseChat}\n          messages={currentMessages}\n          isAdmin={true}\n          // @ts-ignore\n          isOnline={isOnline}\n          handleClick={handleSetSeen}\n        />\n      )}\n    </>\n  );\n}\n\nconst mapStateToProps = (state: any) => ({\n  openChatWindow: state.ui.openChatBubble,\n});\n\nexport default connect(mapStateToProps, { toggleChatBubble })(AdminMessages);\n"]},"metadata":{},"sourceType":"module"}